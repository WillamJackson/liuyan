# 内容发布媒体文件功能说明

## 功能概述

现在您可以在发布内容时直接上传媒体文件（图片和视频），并与内容建立关联关系。媒体文件将按照您设定的顺序显示，最多支持9个文件。

## 主要特性

### 1. 支持的文件类型
- **图片**: JPG, JPEG, PNG, GIF
- **视频**: MP4, AVI, MOV

### 2. 文件数量限制
- 每个内容最多可关联 **9个** 媒体文件
- 支持图片和视频混合上传

### 3. 上传方式
- **拖拽上传**: 直接拖拽文件到上传区域
- **点击选择**: 点击"选择文件"按钮选择文件
- **批量上传**: 一次可选择多个文件同时上传

### 4. 文件管理
- **预览功能**: 图片显示缩略图，视频显示播放控件
- **排序功能**: 拖拽调整媒体文件显示顺序
- **删除功能**: 点击删除按钮移除不需要的文件
- **去重功能**: 自动检测重复文件，避免重复上传

## 数据库变更

### 新增关联表
创建了 `content_media` 表来管理内容与媒体文件的多对多关系：

```sql
CREATE TABLE content_media (
    content_id INT NOT NULL,
    media_file_id INT NOT NULL,
    sort_order INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (content_id, media_file_id)
);
```

### 更新的模型关系
- `Content` 模型新增 `media_files` 关系字段
- `MediaFile` 模型新增 `contents` 反向关系字段

## API接口更新

### 1. 新增内容发布专用上传接口
```
POST /api/content/media/upload
```
- 支持批量上传（最多9个文件）
- 只允许图片和视频文件
- 返回上传成功的文件ID列表

### 2. 内容创建/更新接口增强
```
POST /api/contents
PUT /api/contents/<id>
```
新增 `media_file_ids` 字段，用于关联媒体文件：
```json
{
    "title": "内容标题",
    "content": "内容正文",
    "media_file_ids": [1, 2, 3]
}
```

### 3. 内容详情接口增强
```
GET /api/contents/<id>
```
返回数据中新增 `media_files` 字段，包含关联的媒体文件信息（按排序顺序）。

## 使用流程

### 1. 新建内容
1. 访问内容编辑器页面
2. 填写标题和内容
3. 在"媒体文件"区域上传图片或视频
4. 拖拽调整媒体文件顺序
5. 保存或发布内容

### 2. 编辑现有内容
1. 在内容列表中点击编辑按钮
2. 页面自动加载现有的媒体文件
3. 可以添加新文件或删除现有文件
4. 重新排序后保存

### 3. 查看内容
- 内容列表中显示媒体文件数量标识
- 内容详情页面按顺序显示所有关联的媒体文件

## 文件存储

### 存储结构
```
uploads/
├── images/
│   ├── 2024/01/
│   └── thumbnails/
└── videos/
    └── 2024/01/
```

### 文件处理
- **图片压缩**: 自动压缩大尺寸图片
- **缩略图生成**: 为图片生成缩略图
- **文件去重**: 基于MD5哈希值检测重复文件

## 注意事项

1. **文件大小限制**: 默认最大16MB，可在系统设置中调整
2. **安全检查**: 上传的文件会进行基础的安全扫描
3. **存储空间**: 定期清理未使用的媒体文件以节省存储空间
4. **备份建议**: 建议定期备份 `uploads` 目录和数据库

## 数据库迁移

如果您是从旧版本升级，请执行以下SQL脚本：

```bash
# 执行数据库迁移
mysql -u your_username -p your_database < database/add_content_media_table.sql
```

## 故障排除

### 常见问题

1. **上传失败**
   - 检查文件类型是否支持
   - 确认文件大小未超过限制
   - 检查服务器磁盘空间

2. **图片不显示**
   - 检查文件路径是否正确
   - 确认Web服务器有权限访问uploads目录

3. **排序不生效**
   - 确保浏览器支持HTML5拖拽功能
   - 检查JavaScript是否正常加载

如有其他问题，请查看服务器日志或联系技术支持。 